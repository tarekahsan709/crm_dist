{"version":3,"sources":["api/user/user.controller.js"],"names":["index","create","show","destroy","patch","changePassword","me","authCallback","respondWithResult","res","statusCode","entity","status","json","patchUpdates","patches","apply","err","reject","save","validationError","handleError","send","handleEntityNotFound","end","req","findAll","attributes","then","users","catch","next","newUser","build","body","setDataValue","user","token","sign","_id","secrets","session","expiresIn","userId","params","id","find","where","profile","oldPass","String","oldPassword","newPass","newPassword","authenticate","password","redirect"],"mappings":"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","file":"user.controller.js","sourcesContent":["'use strict';\n\nimport jsonpatch from 'fast-json-patch';\nimport {User} from '../../sqldb';\nimport passport from 'passport';\nimport config from '../../config/environment';\nimport jwt from 'jsonwebtoken';\n\n\nfunction respondWithResult(res, statusCode) {\n    statusCode = statusCode || 200;\n    return function(entity) {\n        if(entity) {\n            return res.status(statusCode).json(entity);\n        }\n        return null;\n    };\n}\n\nfunction patchUpdates(patches) {\n    return function(entity) {\n        try {\n            jsonpatch.apply(entity, patches, /*validate*/ true);\n        } catch(err) {\n            return Promise.reject(err);\n        }\n\n        return entity.save();\n    };\n}\n\nfunction validationError(res, statusCode) {\n    statusCode = statusCode || 422;\n    return function (err) {\n        return res.status(statusCode).json(err);\n    }\n}\n\nfunction handleError(res, statusCode) {\n    statusCode = statusCode || 500;\n    return function (err) {\n        return res.status(statusCode).send(err);\n    };\n}\n\nfunction handleEntityNotFound(res) {\n    return function(entity) {\n        if(!entity) {\n            res.status(404).end();\n            return null;\n        }\n        return entity;\n    };\n}\n\n\n/**\n * Get list of users\n * restriction: 'admin'\n */\nexport function index(req, res) {\n    return User.findAll({\n        attributes: [\n            '_id',\n            'name',\n            'firstName',\n            'lastName',\n            'email',\n            'activate',\n            'role',\n            // 'createdAt',\n            // 'updatedAt',\n            'provider'\n        ]\n    })\n        .then(users => {\n            res.status(200).json(users);\n        })\n        .catch(handleError(res));\n}\n\n/**\n * Creates a new user\n */\nexport function create(req, res, next) {\n    var newUser = User.build(req.body);\n    newUser.setDataValue('provider', 'local');\n    // newUser.setDataValue('role', 'user');\n    return newUser.save()\n        .then(function (user) {\n            var token = jwt.sign({_id: user._id}, config.secrets.session, {\n                expiresIn: 60 * 60 * 5\n            });\n            res.json({token});\n        })\n        .catch(validationError(res));\n}\n\n/**\n * Get a single user\n */\nexport function show(req, res, next) {\n    var userId = req.params.id;\n\n    return User.find({\n        where: {\n            _id: userId\n        }\n    })\n        .then(user => {\n            if (!user) {\n                return res.status(404).end();\n            }\n            res.json(user.profile);\n        })\n        .catch(err => next(err));\n}\n\n/**\n * Deletes a user\n * restriction: 'admin'\n */\nexport function destroy(req, res) {\n    return User.destroy({where: {_id: req.params.id}})\n        .then(function () {\n            res.status(204).end();\n        })\n        .catch(handleError(res));\n}\n\n/**\n * Update a user\n * restriction: 'admin'\n */\nexport function patch(req, res) {\n    // console.log('request****************************************************')\n    // console.log(req);\n    // console.log('response****************************************************')\n    // console.log(res);\n\n    if (req.body._id) {\n        delete req.body._id;\n    }\n    return User.find({\n        where: {\n            _id: req.params.id\n        }\n    })\n        .then(handleEntityNotFound(res))\n        .then(patchUpdates(req.body))\n        .then(respondWithResult(res))\n        .catch(handleError(res));\n\n}\n\n\n/**\n * Change a users password\n */\nexport function changePassword(req, res, next) {\n    var userId = req.user._id;\n    var oldPass = String(req.body.oldPassword);\n    var newPass = String(req.body.newPassword);\n\n    return User.find({\n        where: {\n            _id: userId\n        }\n    })\n        .then(user => {\n            if (user.authenticate(oldPass)) {\n                user.password = newPass;\n                return user.save()\n                    .then(() => {\n                        res.status(204).end();\n                    })\n                    .catch(validationError(res));\n            } else {\n                return res.status(403).end();\n            }\n        });\n}\n\n/**\n * Get my info\n */\nexport function me(req, res, next) {\n    var userId = req.user._id;\n\n    return User.find({\n        where: {\n            _id: userId\n        },\n        attributes: [\n            '_id',\n            'name',\n            'firstName',\n            'lastName',\n            'email',\n            'activate',\n            'role',\n            'provider'\n        ]\n    })\n        .then(user => { // don't ever give out the password or salt\n            if (!user) {\n                return res.status(401).end();\n            }\n            res.json(user);\n        })\n        .catch(err => next(err));\n}\n\n/**\n * Authentication callback\n */\nexport function authCallback(req, res, next) {\n    res.redirect('/');\n}\n"]}